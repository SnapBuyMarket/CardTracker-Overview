<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CardTracker Ingest</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:0;background:#f3f3f3;}
    .top{position:sticky;top:0;background:#222;color:#fff;padding:8px 12px;display:flex;gap:8px;align-items:center;z-index:10}
    .btn{background:#2ecc71;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#3498db}
    .btn.small{padding:6px 10px}
    input[type="text"],select{padding:6px 8px;border-radius:6px;border:1px solid #ccc}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;padding:12px}
    .card{background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .card img{width:100%;height:180px;object-fit:cover;border-top-left-radius:10px;border-top-right-radius:10px;background:#000}
    .meta{padding:8px;font-size:12px;display:flex;align-items:center;gap:6px}
    .foot{padding:8px;font-size:12px;color:#777}
    .pill{display:inline-block;padding:2px 6px;border-radius:8px;background:#444;color:#fff}
    .right{margin-left:auto}
    label.auto{display:flex;align-items:center;gap:6px;margin-left:8px;color:#fff}
  </style>
</head>
<body>
  <div class="top">
    <strong>CardTracker Ingest</strong>
    <span class="pill">Staging: {{ staging }}</span>
    <span class="pill">AltViews: {{ altviews }}</span>
    <span class="right"></span>

    <input id="cardno" type="text" placeholder="Card # e.g. 24" style="width:120px">
    <select id="sport">
      <option>Basketball</option><option>Football</option><option>Baseball</option>
      <option>Hockey</option><option>Soccer</option><option>WNBA</option>
      <option>NASCAR</option><option selected>Other</option>
    </select>

    <button class="btn" onclick="assign(false)">Assign</button>
    <button class="btn secondary" onclick="assign(true)">Assign + Get MV</button>

    <!-- New: open Dashboard in a new window -->
    <button class="btn small" onclick="window.open('{{url_for('dashboard')}}','_blank')">Open Dashboard (new window)</button>

    <!-- auto-refresh toggle -->
    <label class="auto"><input id="autoref" type="checkbox"> auto</label>
    <button class="btn small" onclick="location.reload()">Refresh</button>
  </div>

  <div class="grid">
    {% for f in files %}
      <div class="card">
        <img src="{{ url_for('staging_file', name=f) }}" alt="{{f}}">
        <div class="meta">
          <input type="checkbox" class="pick" value="{{f}}">
          <span>{{f}}</span>
        </div>
        <div class="foot">Staging</div>
      </div>
    {% endfor %}
    {% if not files %}
      <div style="padding:16px;color:#666;">No images in Staging. Drop 2â€“3 into <code>{{ staging }}</code> and hit Refresh.</div>
    {% endif %}
  </div>

<script>
  // auto-refresh every 10s if checked
  (function(){
    const cb = document.getElementById('autoref'); if(!cb) return;
    const KEY = 'ingest_autoref';
    try { cb.checked = sessionStorage.getItem(KEY) === '1'; } catch(_) {}
    let t=null;
    function apply(){ clearInterval(t); if(cb.checked){ t=setInterval(()=>location.reload(), 10000); } }
    cb.addEventListener('change', ()=>{ try{ sessionStorage.setItem(KEY, cb.checked ? '1':'0'); }catch(_){}; apply(); });
    apply();
  })();

  async function assign(withMV){
    const picks = [...document.querySelectorAll('.pick:checked')].map(x=>x.value);
    const cardno = document.getElementById('cardno').value.trim();
    const sport  = document.getElementById('sport').value;
    if(picks.length===0){ alert("Select at least one image."); return; }
    if(!cardno){ alert("Enter Card # (e.g. 24)."); return; }
    const res = await fetch("{{url_for('api_assign')}}", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({files: picks, card_number: cardno, sport: sport, get_mv: withMV})
    });
    const data = await res.json();
    if(!res.ok){ alert("Error: "+(data.error||res.status)); return; }
    alert("Assigned to group: "+data.group_id+" \nMoved: "+data.moved.length+" file(s).");
    location.reload();
  }
</script>
</body>
</html>
